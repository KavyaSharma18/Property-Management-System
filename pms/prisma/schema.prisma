generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model accounts {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model alerts {
  id               String            @id @default(cuid())
  severity         String
  message          String
  isRead           Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  propertyId       String
  eventId          String?
  userId           String
  ambiguity_events ambiguity_events? @relation(fields: [eventId], references: [id])
  properties       properties        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users            users             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ambiguity_events {
  id             String     @id @default(cuid())
  eventTimestamp DateTime   @default(now())
  personCount    Int?
  ambiguityScore Float
  videoClipUrl   String?
  description    String?
  resolved       Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  propertyId     String
  detectedBy     String?
  alerts         alerts[]
  users          users?     @relation(fields: [detectedBy], references: [id])
  properties     properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model guests {
  id               String             @id @default(cuid())
  name             String
  email            String?
  phone            String
  alternatePhone   String?            // Secondary contact number
  idProofType      IdProofType?       // Type of ID proof
  otherIdProof     String?            // Custom ID proof type if OTHER is selected
  idProofNumber    String?            // ID proof number
  idProofImage     String?            // URL to uploaded ID proof image
  address          String?
  city             String?
  state            String?
  country          String?            @default("India")
  nationality      String?            @default("Indian")
  dateOfBirth      DateTime?          // For age verification
  gender           String?            // MALE, FEMALE, OTHER
  emergencyContact String?            // Emergency contact name
  emergencyPhone   String?            // Emergency contact number
  notes            String?            // Any special notes about guest
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  occupancies      occupancies[]
  occupancy_guests occupancy_guests[] // All room bookings this guest is part of
}

model occupancies {
  id                String             @id @default(cuid())
  checkInTime       DateTime           @default(now())
  expectedCheckOut  DateTime?          // Optional - may not be known at booking
  actualCheckOut    DateTime?          // Set when guest actually checks out
  numberOfOccupants Int                // Number of guests in this booking
  actualCapacity    Int?               // Dynamic capacity set at booking (can exceed room default)
  actualRoomRate    Float              // Price per night set during booking (may differ from room default)
  totalAmount       Float              // Total amount (nights Ã— actualRoomRate)
  paidAmount        Float?             @default(0) // Total paid so far
  balanceAmount     Float?             // Remaining to be paid (totalAmount - paidAmount)
  lastPaidDate      DateTime?          // Last date payment covers up to
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  roomId              String
  guestId             String             // Primary guest (main booker)
  checkedInBy         String
  groupBookingId      String?
  bookingSource       BookingSource      @default(WALK_IN) // How the booking was made
  corporateBookingId  String?            // Reference to corporate booking if applicable
  users               users              @relation(fields: [checkedInBy], references: [id])
  guests              guests             @relation(fields: [guestId], references: [id], onDelete: Cascade)
  rooms               rooms              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  group_bookings      group_bookings?    @relation(fields: [groupBookingId], references: [id])
  corporate_bookings  corporate_bookings? @relation(fields: [corporateBookingId], references: [id])
  occupancy_guests    occupancy_guests[] // All guests in this room
  payments            payments[]         // All payment transactions
}

model properties {
  id                                     String             @id @default(cuid())
  name                                   String             @unique
  address                                String
  city                                   String?
  state                                  String?
  zipCode                                String?
  country                                String?            @default("India")
  description                            String?
  amenities                              String?            // JSON string of amenities
  images                                 String?            // JSON array of image URLs
  numberOfFloors                         Int
  totalRooms                             Int
  status                                 PropertyStatus     @default(ACTIVE)
  createdAt                              DateTime           @default(now())
  updatedAt                              DateTime           @updatedAt
  ownerId                                String
  receptionistId                         String?            @unique
  alerts                                 alerts[]
  ambiguity_events                       ambiguity_events[]
  floors                                 floors[]
  users_properties_ownerIdTousers        users              @relation("properties_ownerIdTousers", fields: [ownerId], references: [id], onDelete: Cascade)
  users_properties_receptionistIdTousers users?               @relation("properties_receptionistIdTousers", fields: [receptionistId], references: [id])
  rooms                                  rooms[]
  group_bookings                         group_bookings[]     // Group bookings
  corporate_bookings                     corporate_bookings[] // Corporate bookings
}

model floors {
  id          String     @id @default(cuid())
  floorNumber Int
  floorName   String?    // e.g., "Ground Floor", "First Floor"
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  propertyId  String
  properties  properties @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  rooms       rooms[]

  @@unique([propertyId, floorNumber])
}

model rooms {
  id            String        @id @default(cuid())
  roomNumber    String
  roomType      RoomType
  roomCategory  RoomCategory  @default(MODERATE)
  capacity      Int           // Recommended capacity
  pricePerNight Float         // Default price (can be changed during booking)
  description   String?
  amenities     String?       // JSON string of room-specific amenities
  images        String?       // JSON array of room image URLs
  size          Float?        // Room size in square feet/meters
  status        RoomStatus    @default(VACANT)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  propertyId    String
  floorId       String
  floors        floors        @relation(fields: [floorId], references: [id], onDelete: Cascade)
  occupancies   occupancies[]
  properties    properties    @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, roomNumber])
}

model sessions {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model users {
  id                                          String             @id @default(cuid())
  name                                        String?
  email                                       String             @unique
  emailVerified                               DateTime?
  phone                                       String?            // Phone number
  phoneVerified                               DateTime?          // Phone verification timestamp
  phoneVerificationCode                       String?            // OTP for phone verification
  phoneVerificationExpiry                     DateTime?          // OTP expiry time
  image                                       String?
  password                                    String?
  role                                        Role?
  propertyId                                  String?            // Property assigned to receptionist/staff
  isActive                                    Boolean            @default(true)
  createdAt                                   DateTime           @default(now())
  updatedAt                                   DateTime           @updatedAt
  accounts                                    accounts[]
  alerts                                      alerts[]
  ambiguity_events                            ambiguity_events[]
  occupancies                                 occupancies[]
  properties_properties_ownerIdTousers        properties[]       @relation("properties_ownerIdTousers")
  properties_properties_receptionistIdTousers properties?          @relation("properties_receptionistIdTousers")
  sessions                                    sessions[]
  group_bookings                              group_bookings[]     // Group bookings created
  corporate_bookings                          corporate_bookings[] // Corporate bookings created
  payments                                    payments[]           // Payments received
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Junction table: Track all guests staying in each room booking
model occupancy_guests {
  id          String      @id @default(cuid())
  occupancyId String
  guestId     String
  isPrimary   Boolean     @default(false) // Main guest who booked
  createdAt   DateTime    @default(now())
  occupancies occupancies @relation(fields: [occupancyId], references: [id], onDelete: Cascade)
  guests      guests      @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([occupancyId, guestId])
}

// Group bookings: Multiple rooms booked together
model group_bookings {
  id           String        @id @default(cuid())
  groupName    String        // Group/company name
  propertyId   String
  totalRooms   Int
  checkInDate  DateTime
  checkOutDate DateTime
  contactName  String?
  contactPhone String?
  contactEmail String?
  notes        String?
  createdBy    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  properties   properties    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users        users         @relation(fields: [createdBy], references: [id])
  occupancies  occupancies[] // All rooms in this group
}

// Corporate bookings: Track company bookings with company details
model corporate_bookings {
  id              String        @id @default(cuid())
  companyName     String        // Company/Organization name
  contactPerson   String        // Primary contact person name
  contactPhone    String
  contactEmail    String?
  gstNumber       String?       // GST registration number
  notes           String?
  propertyId      String
  createdBy       String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  properties      properties    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  users           users         @relation(fields: [createdBy], references: [id])
  occupancies     occupancies[] // All bookings under this corporate account
}

// Payment transactions: Track all payments with partial payment support
model payments {
  id            String      @id @default(cuid())
  occupancyId   String
  amount        Float       // Amount paid in this transaction
  paymentMethod String      // CASH, CARD, UPI, BANK_TRANSFER, CHEQUE
  paymentDate   DateTime    @default(now())
  paidUpToDate  DateTime?   // Date this payment covers up to (for partial payments)
  transactionId String?     // Reference for digital payments
  notes         String?
  receivedBy    String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  occupancies   occupancies @relation(fields: [occupancyId], references: [id], onDelete: Cascade)
  users         users       @relation(fields: [receivedBy], references: [id])
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
}

enum Role {
  OWNER
  RECEPTIONIST
}

enum RoomStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
  RESERVED
  DIRTY      // Needs cleaning after checkout
  CLEANING   // Currently being cleaned
}

enum RoomType {
  DELUXE
  SUITE
  AC
  NON_AC
}

enum RoomCategory {
  ECONOMY      // Cheap, basic amenities
  MODERATE     // Standard, good amenities
  PREMIUM      // Very good, better amenities
  ELITE        // Luxury, best amenities
  VIP          // Exclusive, top-tier service
}

enum IdProofType {
  AADHAAR_CARD
  PASSPORT
  DRIVING_LICENSE
  VOTER_ID
  PAN_CARD
  RATION_CARD
  OTHER
}

enum BookingSource {
  WALK_IN           // Direct walk-in at property
  PHONE_CALL        // Booked via phone
  GOIBIBO           // Online travel agency
  MAKEMYTRIP        // Online travel agency
  BOOKING_DOT_COM   // Booking.com
  AIRBNB            // Airbnb platform
  AGODA             // Agoda platform
  EXPEDIA           // Expedia platform
  CORPORATE         // Corporate booking
  TRAVEL_AGENT      // Through travel agent
  WEBSITE           // Property's own website
  OTHER             // Other sources
}
